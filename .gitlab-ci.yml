before_script:
    - which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )
    - eval $(ssh-agent -s)
    - ssh-add <(echo "$SSH_PRIVATE_KEY")
    - git clone https://gitlab.com/schabrolles/ansible-rear.git
    - cd ansible-rear
    - git checkout gitlab-ci
    - echo "$VAULT_PASSWD" > personal_vault_pass

stages:
    - ReaR_Setup
    - ReaR_ISO_test
    - ReaR_NETFS_Backup
    - ReaR_NETFS_Recover
    - ReaR_NETFS_Check

Start_ReaR_master:
    stage: ReaR_Setup
    tags:
        - ppc64le
    script:
        - ansible-playbook rear_start_master.yml

ReaR_setup:
    stage: ReaR_Setup
    tags:
        - ppc64le
    script:
        - ansible-playbook rear_setup.yml -e rear_git_url=http://github.com/rear/rear -e rear_git_branch=master

Test_ISO_creation:
    stage: ReaR_ISO_test
    tags:
        - ppc64le
    script:
        - ansible-playbook rear_ISO_creation.yml

NETFS_Backup:
    stage: ReaR_NETFS_Backup
    tags:
        - ppc64le
    script:
        - ansible-playbook rear_PXE_Backup.yml

NETFS_Recover:
    stage: ReaR_NETFS_Recover
    tags:
        - ppc64le
    script:
        - ansible-playbook rear_PXE_recovery.yml

NETFS_Check:
    stage: ReaR_NETFS_Check
    tags:
        - ppc64le
    script:
        - ansible-playbook rear_final_check_and_shutdown.yml
    when: always
